11/21/2018 -- Set up reverse tunneling using ic2-widpatcon2 as the example

We assign these ports:

    50103 ic-widpatcon
    50114 ic2-widpatcon2

Replace myEc2Instance.com with the name or IP address of the relay server.  An
Amazon Web Services (AWS) Elastic Compute Cloud (EC2) server is assumed.



Basic Setup
===========

Create user illumicone on myEc2Instance.com and create an ssh key pair for it.

sudo adduser illumicone
sudo su - illumicone
mkdir .ssh
chmod 700 .ssh
cd .ssh
touch authorized_keys
chmod 600 authorized_keys
ssh-keygen
cat id_rsa.pub >> authorized_keys
cp id_rsa illumiconeAwsEC2.pem
cp id_rsa.pub illumiconeAwsEC2.pub
cat illumiconeAwsEC2.pem
(Copy/paste to local file named illumiconeAwsEC2.pem.)


Copy illumiconeAwsEC2.pem to .ssh on the Illumicone host (e.g., ic2-widpatcon2).
Set the permissions to 400.


Test:  Open a reverse tunnel from the AWS EC2 instance back to ic2-widpatcon2.

ssh -f -N -T -R50114:localhost:22 -i ~/.ssh/illumiconeAwsEC2.pem illumicone@myEc2Instance.com


Test:  ssh to myEc2Instance.com and open a terminal on ic2-widpatcon2.

ssh -i ~/.ssh/illumiconeAwsEC2.pem illumicone@myEc2Instance.com

ssh -p 50114 illumicone@localhost


Transfer illumicone's public key from myEc2Instance.com to ic2-widpatcon2.

scp -P 50114 ~/.ssh/illumiconeAwsEC2.pub illumicone@127.0.0.1:


Test:  Connect to ic2-widpatcon2 using ssh key pair.

ssh -i .ssh/illumiconeAwsEC2.pem -p 50114 illumicone@localhost


On myEc2Instance.com, create .ssh/config with this content:

Host i2widpatcon2
    HostName localhost
    User illumicone
    Port 50114
    IdentityFile .ssh/illumiconeAwsEC2.pem
    PubkeyAuthentication yes
    StrictHostKeyChecking false
    PasswordAuthentication no


Test .ssh/config.

ssh i2widpatcon2



autossh
=======

install autossh on ic2-widpatcon2.

sudo apt-get autossh


Test autossh.

autossh -M 0 -fN -o "PubkeyAuthentication=yes" -o "StrictHostKeyChecking=false" -o "PasswordAuthentication=no" -o "ServerAliveInterval 60" -o "ServerAliveCountMax 3" -R50114:localhost:22 -i ~/.ssh/illumiconeAwsEC2.pem illumicone@myEc2Instance.com

(Log in from myEc2Instance.com.)


On ic2-widpatcon2, create .ssh/config with this content:

Host ic2-widpatcon2-tunnel
    HostName myEc2Instance.com
    User illumicone
    IdentityFile ~/.ssh/illumiconeAwsEC2.pem
    RemoteForward 50114 localhost:22
    PubkeyAuthentication yes
    StrictHostKeyChecking false
    PasswordAuthentication no
    ServerAliveInterval 60
    ServerAliveCountMax 3


Test .ssh/config.

autossh -M 0 -f -T -N ic2-widpatcon2-tunnel



Start autossh During Boot
=========================

Create /etc/systemd/system/autossh-tunnel.service with this content:

[Unit]
Description=AutoSSH tunnel service on local port 50114
After=network.target

[Service]
User=illumicone
Type=forking
ExecStart=/usr/bin/autossh -M 0 -f -T -N ic2-widpatcon2-tunnel

[Install]
WantedBy=multi-user.target


Tell systemd that we have added some stuff.

systemctl daemon-reload


Start the service.

systemctl start autossh-tunnel.service


Enable the service startup at boot time.

systemctl enable autossh-tunnel.service



Misc. Commands
==============

Show the open tunnels:

sudo netstat -tpln | grep ssh
sudo lsof -i -n | grep ssh


autossh-tunnel.service troubleshooting commands:

systemctl status autossh-tunnel.service
sudo journalctl -xe




