9/24/2017 -- Set up ic-strdrv on a BeagleBone Green using Debian Jessie


0.  Write the image to a micro-SD card.

    diskutil list
    diskutil unmountDisk /dev/diskN
    sudo dd bs=1m if=bone-debian-8.7-iot-armhf-2017-03-19-4gb.img of=/dev/rdiskN
    diskutil unmountDisk /dev/diskN


1.  Write the image to the on-board flash.

    Boot from the micro-SD card, ssh to beaglebone.local, and log in as
    debian/temppwd.

    Enable the following line in /boot/uEnv.txt:
        ##enable Generic eMMC Flasher:
        ##make sure, these tools are installed: dosfstools rsync
        cmdline=init=/opt/scripts/tools/eMMC/init-eMMC-flasher-v3.sh

    Reboot from the on-board flash.  The 4 user LEDs will flash in succession
    while the image is being written.  When complete, the LEDs will be off,
    and the board will be powered down automatically.  This can take up to ten
    minutes.

    Removed the micro-SD card and reboot from the on-board flash.

    It would be a good idea to erase the micro-SD card so that you don't
    accidentially boot from it and wipe out the setup in the on-board flash.


2.  Update everything.

    Boot from the micro-SD card.

    sudo apt-get update
    sudo apt-get upgrade

    Reboot.


3.  Create user illumicone and add it to the sudo group.

    sudo adduser illumicone
    sudo adduser illumicone sudo


4.  Change user debian's password to be the same as illumicone's.

    passwd

    Remove the "default username:password" line from /etc/issue and
    /etc/issue.net.


5.  Set up ssh keys.

    on development system:  scp ~/.ssh/id_rsa.pub illumicone@beaglebone.local:myrsa.pub

    mkdir .ssh
    cd .ssh
    ssh-keygen
    mv ../myrsa.pub authorized_keys
    chmod 600 authorized_keys


6.  Set the host name to ic-strdrv.

    Change all occurrences of "beaglebone" to "ic-strdrv" in /etc/hostname and
    /etc/hosts.

    Reboot.


7.  Create .bash_aliases

    on development system:  scp ~/devl/Illumicone/sbin/bash_aliases illumicone@ic-strdrv.local:.bash_aliases


8.  Set up time zone and NTP.

    sudo apt-get install ntp

    Add this above the existing server lines in /etc/ntp.conf:

        # On Illumicone's LAN, ic-widcon has the RTC and is an NTP server.
        server 192.168.69.102
        server 192.168.69.103

    sudo timedatectl set-timezone America/Boise


9.  Install required and useful packages.

    sudo apt-get install psmisc git-flow

    (psmisc gives us the killall utility.)


10.  Set up the Illumicone project.

    mkdir devl
    cd ~/devl
    git clone https://github.com/skipzone/Illumicone
    cd Illumicone
    git flow init
    cp ~/devl/Illumicone/config/vimrc ~/.vimrc
    git config --global core.editor "vim"


11.  Disable HDMI.

    The BeagleBone Green does not have HDMI, so this step should not be
    necessary (per Yona Appletree, https://devhub.io/repos/Yona-Appletree-LEDscape).
    For the record and in case a BBB is used instead, enable this line in
    /boot/uEnv.txt to disable HDMI:
        ##BeagleBone Black: HDMI (Audio/Video) disabled:
        dtb=am335x-boneblack-emmc-overlay.dtb


12.  Set up LEDscape.

        cd devl
        git clone git://github.com/Yona-Appletree/LEDscape
        cd LEDscape

sudo cp /boot/dtbs/$(uname -r)/am335x-bonegreen.dtb{,.original}

cd /opt/source/dtb-4.4-ti/src/arm
sudo debian
cp am335x-bonegreen.dts am335x-bonegreen.dts.original
Disable remoteproc and enable uio in am335x-bonegreen.dts:
    Enable this line:  #include "am33xx-pruss-uio.dtsi"
    Comment out this line:  /* #include "am33xx-pruss-rproc.dtsi" */
Fix the name of the device tree compiler (dtc) in Makefile.
    cp Makefile Makefile.original
    Make this edit:
        #DTC ?= /usr/bin/dtc-v4.1.x
        DTC ?= /usr/bin/dtc
make src/arm/am335x-bonegreen.dtb
sudo cp src/arm/am335x-bonegreen.dtb /boot/dtbs/4.4.54-ti-r93/
exit
cd
sudo cp /etc/modprobe.d/pruss-blacklist.conf pruss-blacklist.conf.original
Replace this line in /etc/modprobe.d/pruss-blacklist.conf:
    blacklist uio_pruss
with these:
    blacklist pruss
    blacklist pruss_intc
    blacklist pru-rproc

Cross your fingers and reboot.

Check:
    lsmod | grep uio
Output should be:
uio_pruss       4928 0
uio_pdrv_genirq 3539 0
uio             8822 2 uio_pruss,uio_pdrv_genirq


This is the wrong output:
illumicone@ic-strdrv:~$ lsmod | grep uio
uio_pdrv_genirq         3923  0 
uio                    10524  1 uio_pdrv_genirq


=-=-=-=-=-=-=-=
Wheezy only?  Not necessary on Jessie?  Is Jessie even compatible with LEDscape?
        sudo cp /boot/dtbs/$(uname -r)/am335x-bonegreen.dtb{,.originalBeforeLEDscape}

cp am335x-boneblack.dtb /boot/dtbs/$(uname -r)/ 
cp am335x-green.dtb /boot/dtbs/$(uname -r)/ 
modprobe uio_pruss  
vi /boot/uEnv.txt
reboot

- sudo cp am335x-boneblack.dtb /boot/dtbs/3.8.13-bone79/

- sudo modprobe -v uio_pruss

- sudo reboot

=-=-=-=-=-=-=-=

- make

- sudo ./install-service.sh





x.  Assign static IP address 192.168.69.100 for ic-strdrv on wired network.


================================================================================


7/8/2017 - Set up ic-patcon with new jessie image
=================================================

- Log in as user debian, password temppwd.

- Create user illumicone and add it to the sudo group.
  
    adduser illumicone
    sudo adduser illumicone sudo

- Change user debian's password to the same as illumicone's.

    passwd

- Remove the "default username:password" line from /etc/issue and
  /etc/issue.net.

- Set the host name to ic-patcon by changing all occurrences of "beaglebone"
  to "ic-patcon" in /etc/hostname and /etc/hosts.

- Assign the static IP address for ic-patcon.  jessie uses that fucking connman,
  so use this:

    sudo connmanctl services

  Note which service is ethernet_hexshit_cable.  Then,

    sudo connmanctl config ethernet_hexshit_cable --ipv4 manual 192.168.69.101 255.255.255.0 192.168.69.1 --nameservers 192.168.69.1 8.8.8.8
  
  Your ssh connection will go away because the address change will be immediate.

  The old way of modifying the eth0 section of /etc/network/interfaces doesn't
  work anymore.  For reference, here is what we used to use:

    auto eth0
    iface eth0 inet static
        address 192.168.69.101
        netmask 255.255.255.0
        network 192.168.69.0   <-- not sure if this is needed
        gateway 192.168.69.1

- Reboot then log in as illumicone.

- Create .bash_aliases, copy aliases from .bashrc.

- Do updates.

    sudo apt-get update
    sudo apt-get upgrade

- Set up ssh keys.

    ssh-keygen

    Add desired public keys to ~/.ssh/authorized_keys, and make sure that
    file's permissions are 600.

- Set up time zone and NTP.

    sudo apt-get install ntp

    Add this above the existing server lines in /etc/ntp.conf:

        # On Illumicone's LAN, ic-widcon has the RTC and is an NTP server.
        server 192.168.69.102
        server 192.168.69.103

    sudo rm /etc/localtime; sudo ln -s /usr/share/zoneinfo/America/Boise /etc/localtime

        --> Check this.  After reboot, /etc/timezone still says "Etc/UTC".
        But, the output from timedatectl looks correct.  Try this command
        instead:  sudo timedatectl set-timezone America/Boise

- Install psmisc to get the killall utility.

    sudo apt-get install psmisc

- Install git flow.

    sudo apt-get install git-flow

- Create the ~/devl directory.

- In ~/devl, clone the Illumicone project.

    git clone https://github.com/skipzone/Illumicone

- If using an SD card larger than 4 GB, expand the partition then reboot
  immediately afterward.

    (May need to do "git pull" in /opt/scripts/tools.)

    /opt/scripts/tools/grow_partition.sh



1/17/2016 (updated 6/21/2016)
=========

On a new BeagleBone Black that came with the 2015-03-01 image (Debian 4.6.3-14, 3.8.13-bone70) (using sudo for most things):

- apt-get update

- apt-get upgrade

- Edit .bashrc, enable aliases.  (Update 6/21/2016: Create .bash_aliases,
  copy aliases from .bashrc.)

- Edit boot/uEnv.txt, disable HDMI by un-commenting-out this line:
  #cape_disable=capemgr.disable_partno=BB-BONELT-HDMI,BB-BONELT-HDMIN
  uEnv.txt can be accessed by mounting /dev/mmcblk0p2.  (Update 6/21/2016:
  If booted from the onboard flash then that device is already mounted
  at /.)

- In /opt/scripts/tools, "git pull" then ./update_kernel.sh

- Edit /etc/network/interfaces, enable WiFi and eth0.  (If eth0 is not
  explicitly enabled, the Ethernet cable must be connected to the board
  before power-up.  (Update 6/21/2016:  That doesn’t appear to be true,
  at least when WiFi is not enabled.))

  Make sure the wlan0 section looks like this:

  auto wlan0
  iface wlan0 inet dhcp
      wpa-driver wext
      wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf

- Add this to /etc/wpa_supplicant/wpa_supplicant.conf (create the file
  if necessary):

  ctrl_interface=/var/run/wpa_supplicant

  network={
      ssid=“ssid1”
      psk=“password1”
      id_str=“netname1”
  }

  network={
      ssid=“ssid2”
      psk=“password2”
      id_str=“netname2”
  }

- sudo rm /etc/localtime; sudo ln -s /usr/share/zoneinfo/America/Boise /etc/localtime

- Install the wifi-reset service:  (Update 6/21/2016:  Probably don’t do
  this.  The service makes it take longer than fuck for the system to boot
  and LEDscape to start.  Also, it doesn’t appear to be necessary with the
  Edimax N150 (EW-7811Un).)

    - cd
    - git clone https://github.com/adafruit/wifi-reset.git
    - cd wifi-reset
    - sudo ./install.sh

  The wifi-reset service can be disabled with this command:

      sudo systemctl disable wifi-reset.service


Notes
-----

If the WiFi dongle is plugged in after the system is running, you must do
"sudo ifup wlan0" to make it associate with the WiFi network.

When using an SD card larger than 4 GB, use
/opt/scripts/tools/grow_partition.sh to expand the partition.  Reboot immediately afterward.


LEDscape Setup
--------------

- git clone git://github.com/Yona-Appletree/LEDscape

- cd LEDscape

- sudo cp /boot/dtbs/3.8.13-bone79/am335x-boneblack.dtb{,.originalBeforeLEDscape}

- sudo cp am335x-boneblack.dtb /boot/dtbs/3.8.13-bone79/

- sudo modprobe -v uio_pruss

- sudo reboot

- make

- sudo ./install-service.sh

The osresearch branch specifies this command, which seems to be unnecessary
for the Yona-Appletree branch:
echo 'options uio_pruss extram_pool_sz=0x800000' | sudo tee -a /etc/modprobe.d/ledscape.conf

